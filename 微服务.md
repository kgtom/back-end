## 一、背景
* 互联网时代，面对较大用户量，提高用户体验、系统吞吐量
* 单体应用无法满足当前需求，举例例子：一只筷子一折就断，一把筷子怎么都折不断，可见人多力量大的思想是多么的重要，但是人多也不一定能解决所有事情，还得进行有序、合理的分配任务，进行有效的管理，对应互联网就是两个字： **拆分**，包括水平(多个节点具有同样功能)和垂直(专业事交给专业人去做)拆分。(ps:拆分后面临分布式一致性问题)
* 传统soa模式中心化服务，对ESB服务总线依赖太多，不是点对点通讯，容易造成雪崩，而分布式服务去中心化服务支持点对点通讯，减少网络成本


## 二、理论-康威定律
在康威的这篇文章中，最有名的一句话就是：
~~~
   Organizations which design systems are constrained to produce designs which are copies of the communication structures of these organizations. - Melvin Conway(1967)
~~~
用通俗的说法就是：**组织形式等同系统设计**。具体如下：
* 人与人的沟通是非常复杂的，一个人的沟通精力是有限的，所以当问题太复杂需要很多人解决的时候，我们需要做拆分组织来达成对沟通效率的管理
* 如果子系统是内聚的，和外部的沟通边界是明确的，能降低沟通成本，对应的设计也会更合理高效
* 复杂的系统需要通过容错弹性的方式持续优化，不要指望一个大而全的设计或架构，好的架构和设计都是慢慢迭代出来的

**具体的实践建议：**
1. 以提升效率为目标，两个人能讲清楚的就不要找更多人，明确分工，拒绝踢皮球
2. 使用最小可用产品（Minimum Viable Product， MVP）理念，快速完成第一版，尽快让用户试用反馈，不断迭代
3. 按照业务划分团队(小而美团队)，明确业务边界，保持团队高内聚，减少与外部沟通，拒绝扯皮

**结合微服务特点：**
* 分布式服务组成系统
* 根据业务而不是技术拆分
* 自动化运维(docker部署、维护rancher/k8s、日志elk)



## 三、实践--遇到问题

 **轨迹:** 
 单体应用—>分布式(前端、后端、db、文件)—>分布式+缓存---->(高可用)分布式+缓存+负载

**应用场景:**
*  财务系统转账
*  电商系统下订单和去库存
*  同步超时、异步调用超时
*  系统之间状态不一致
*  缓存与数据库不一致



**遇到问题汇总：**
* 分布式事务一致性和性能平衡
* 运维方面：链路跟踪、分析、监控
* 系统依赖问题：a–>b—>c—>d—>a
* 系统调用问题：防御上游，容错下游

## 四、实践--解决问题
**服务目标：**
* 通过业务拆分降低系统复杂度；
* 通过服务共享提供可重用性；
* 通过服务化达到业务支持的敏捷性；
* 通过统一的数据架构消除数据交互的屏障

**遵循原则:**
1. 设计:系统建设遵循面对对象的[基本原则(SOLID)](https://github.com/kgtom/daily-life/blob/master/books/oop%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99.md)，尤其是保持服务的 高内聚、低耦合。
2. 运营:完整的业务模型，要有数据运营和业务整合的价值，[提供管理运营的方法和配套服务](https://github.com/kgtom/daily-life/blob/master/books/%E3%80%8A%E4%BC%81%E4%B8%9AIT%E6%9E%B6%E6%9E%84%E8%BD%AC%E5%9E%8B%E4%B9%8B%E9%81%93--%E6%89%93%E9%80%A0%E6%95%B0%E5%AD%97%E5%8C%96%E8%BF%90%E8%90%A5%E8%83%BD%E5%8A%9B%E3%80%8B.md),即：使用大数据分析数据价值，优化业务模型，甚至找到新的业务增长点

3. 工程:基于分布式架构，虽然解决了一体化架构在大规模应用的问题，但是也引入了分布式事务的问题，所以拆分要慎重，不能图一时之快把业务拆分的非常彻底，到最后投入大量资源去解决技术上的问题。


**解决方案：**

* 一致性问题：
  - 强一致性采用同步(一个db 事务)、
  - 弱(最终)一致性采用异步(消息队列)、事后补偿、日志记录
  
* 依赖和调用：引入api网关、限流
* 内部调用：规定统一的返回值(业务正常、业务异常、程序异常)
* 高可用架构设计：数据易用性(保证给外部提供数据拿来即用)、[分库分表](https://github.com/kgtom/daily-life/blob/master/books/%E3%80%8A%E4%BC%81%E4%B8%9AIT%E6%9E%B6%E6%9E%84%E8%BD%AC%E5%9E%8B%E4%B9%8B%E9%81%93---%E6%95%B0%E6%8D%AE%E5%BA%93%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8%E3%80%8B.md)、主从备份、多数据源匹配(数据异构)
* [服务异步的方式调用和缓存redis使用](https://github.com/kgtom/daily-life/blob/master/books/%E3%80%8A%E4%BC%81%E4%B8%9AIT%E6%9E%B6%E6%9E%84%E8%BD%AC%E5%9E%8B%E4%B9%8B%E9%81%93--%E5%BC%82%E6%AD%A5%E5%8C%96(%E5%88%86%E5%B8%83%E5%BC%8F)%E4%B8%8E%E7%BC%93%E5%AD%98%E3%80%8B.md)，解决大量同步方式带来的性能问题，异步包括(业务流程异步化、db事务异步化)
 

## 五、总结

### **系统不断迭代，从0到1过程**
* 1.流量小：提高开发效率，引入orm 、gin等框架
* 2.动静分离，读写分离，主从备份
* 3.业务垂直拆分,反向代理、分布式缓存
* 4.亿万流量：中心化，柔性服务，自动化（回归，测试，运维，监控）

### **问题 **: 业务流程及db事务异步化如何保证分布式事务一致性

### **回答：**

####  理论基础: ACID 、BASE、CAP，强两者“酸碱理论”，后者名“帽子理论”

* 一. 传统分布式事务：采用两阶段提交或者TCC三阶段提交

* 二. 互联网分布式事务：

   - 引入日志(事务开始、结束日志及数据REDO/UNDO,当事务重试、回滚时，根据日志最终将数据恢复到一致性)及补偿机制，根据CAP，结合业务通常牺牲一致性，追求最终一致性
   - 可靠的信息传递，消息传递有三种状态：成功、失败、不知道成功还是失败。投递有两种方式(仅投递一次、至少投递一次(幂等性，记录业务编号，建立排重表))
  - 实现无锁，两种方式
     - 建立辅助业务明细表。例如：下单成功后，不去减少库存，而是记录库存增减明细表，等支付成功后，再去更新库存数量。
     - 使用版本号的方式实现乐观锁。表中记录版本号字段，事务开始前获取到版本号，事务最后update是获取版本号，如何两者一致则继续更新，否则说明其它事务有修改，放弃本次事务。这种好处避免了长事务中的数据库加锁开销。
     
* 三.根据业务场景，具体做法如下：

* 1.查询模式

    场景：同步数据、同步超时、异步回调超时、各系统状态的不一致
    使用查询模式了解被调用服务的处理情况，来决定下一步操作；是补偿未完成的还是回滚已完成的。

* 2.补偿模式
    分系统自动回复和通知运营线下处理

* 3.异步模式
    电商系统中物流、配送； erp订单和财务结算对账

* 4.使用消息系统(nsq、mq等)
       订单系统A表和记录发送给M的D表---》 消息系统M  ---》 财务系统B表 和记录已处理的订单C表(两者一个事务)

    **讲解：**
    A下单成功后，D表中存储一笔发送记录待发送，向M存储一笔信息，向M发送成功后，改变D表状态 发送成功，该消息通知B有一条结算数据，通知B之前，
          先检查一下C中是否已经处理了过这个订单A的数量，如果没有处理，则处理B并且在C中加一笔数据，B和C一个事务中。
          A下单成功后，如果存储M失败，则定时从D表中获取待发送的消息存储到M.
 * 5. 同步模式
      例如：支付完成后，增加客人的常旅客积分。保证业务数据的实时性和一致性，支付成功后必须加积分，我们让常旅客模块提供新增积分和积分回撤功能。
           具体流程：先增加积分，积分成功后，再调用支付，如果支付失败，则调用积分回撤的API。

  * 6.定时校对，然后进行补偿
        使用消息队列nsq，需要保证nsq是否成功接收，定时校对，然后再执行存储。

    **总结阿里做法：**
    * 分布式MQ队列，解耦模板，提高业务处理的吞吐率和响应时间。
          例如：下单(检查库存数量)—> mq—>支付操作–>mq—>库存减少场景.
    * TCC 典型事后补偿
           注意点：幂等及各个模块之间异步消息来驱动 
> reference:
* [微服务理论](https://github.com/kgtom/daily-life/blob/master/important/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%90%86%E8%AE%BA%E5%8F%8A%E5%AE%9E%E8%B7%B5.md)
* [企业IT架构转型之道](https://github.com/kgtom/daily-life/blob/master/books/%E3%80%8A%E4%BC%81%E4%B8%9AIT%E6%9E%B6%E6%9E%84%E8%BD%AC%E5%9E%8B%E4%B9%8B%E9%81%93---%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA%E3%80%8B.md)
* [分布式系统一致性理论](https://github.com/kgtom/daily-life/blob/master/important/%E8%A7%A3%E5%86%B3%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%B8%80%E8%87%B4%E6%80%A7%E9%9C%80%E8%A6%81%E5%93%AA%E4%BA%9B%E7%90%86%E8%AE%BA.md)
